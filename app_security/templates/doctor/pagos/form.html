{% extends 'base.html' %}
{% load static %}
{% block content %}
{% include 'fragments/messages.html' %}
{% include 'fragments/form_errors.html' %}
<link rel="stylesheet" href="{% static 'forms/premium.css' %}">
<style>
:root {
    --primary-blue: #2563eb;
    --aurora1: #6366f1;
    --aurora2: #22d3ee;
    --aurora3: #fbbf24;
    --btn-login: #4f8cff;
    --btn-login-hover: #6f4fff;
    --gold-premium: #ffd700;
    --gold-light: #ffe066;
    --gold-bg: #fffbe7;
    --gold-hover: #fff7b2;
    --gold-soft: #e6c97a;
    --text-dark: #111827;
    --text-secondary: #64748b;
    --text-sidebar: #374151;
    --bg-body: #f9fafb;
    --bg-secondary: #e0e7ff;
    --text-shadow: #c7d2fe44;
    --danger: #ef4444;
}
.premium-form-card {
    background: rgba(255,255,255,0.97);
    backdrop-filter: blur(24px);
    border: 2.5px solid var(--gold-premium);
    box-shadow: 0 24px 48px -12px var(--aurora1), 0 0 0 4px var(--gold-light);
    border-radius: 2.5rem;
    padding: 2.5rem 2rem 2rem 2rem;
    margin-top: 2.5rem;
    margin-bottom: 2.5rem;
    max-width: 48rem;
    position: relative;
    overflow: hidden;
    animation: fadeInCard 0.8s cubic-bezier(0.4,0,0.2,1);
}
@keyframes fadeInCard {
    0% { opacity: 0; transform: translateY(40px) scale(0.98); }
    100% { opacity: 1; transform: none; }
}
.premium-form-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(120deg, var(--aurora1) 0%, var(--aurora2) 100%);
    opacity: 0.08;
    z-index: 0;
    pointer-events: none;
}
.premium-form-title {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 1.2rem;
    letter-spacing: 0.03em;
    animation: fadeInTitle 1.2s cubic-bezier(0.4,0,0.2,1);
    justify-content: center;
    text-align: center;
}
.premium-form-title .premium-title-text {
    background: linear-gradient(90deg, var(--aurora1), var(--aurora2), var(--gold-premium));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
@keyframes fadeInTitle {
    0% { opacity: 0; transform: translateY(-30px); }
    100% { opacity: 1; transform: none; }
}
.premium-form-title i {
    color: var(--gold-premium);
    font-size: 2.7rem;
    filter: drop-shadow(0 2px 4px var(--gold-soft));
}
.premium-form-group {
    margin-bottom: 1.7rem;
    position: relative;
}
.premium-form-label {
    display: block;
    font-weight: 700;
    color: var(--aurora1);
    margin-bottom: 0.5rem;
    font-size: 1.13rem;
    letter-spacing: 0.01em;
    text-shadow: 0 2px 8px var(--text-shadow);
}
.premium-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}
.premium-input-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--aurora2);
    font-size: 1.2rem;
    pointer-events: none;
    transition: color 0.2s;
    z-index: 2;
}
.premium-form-card input,
.premium-form-card select,
.premium-form-card textarea {
    width: 100%;
    border-radius: 1rem;
    border: 2px solid var(--gold-premium);
    background: rgba(255,255,255,0.93);
    padding: 0.85rem 1.25rem 0.85rem 2.7rem;
    font-size: 1.08rem;
    color: var(--text-dark);
    transition: border 0.2s, box-shadow 0.2s, background 0.2s;
    box-shadow: 0 2px 8px 0 var(--aurora1);
    outline: none;
    z-index: 1;
}
.premium-form-card input:focus,
.premium-form-card select:focus,
.premium-form-card textarea:focus {
    border-color: var(--aurora1);
    background: rgba(255,255,255,0.99);
    box-shadow: 0 0 0 6px var(--aurora2);
}
.premium-form-error {
    display: inline-block;
    background: var(--gold-bg);
    color: var(--danger);
    border: 1.5px solid var(--gold-premium);
    border-radius: 0.75rem;
    padding: 0.4rem 1rem;
    font-size: 0.98rem;
    margin-bottom: 0.5rem;
    margin-top: 0.2rem;
    font-weight: 600;
    box-shadow: 0 2px 8px 0 var(--gold-light);
    animation: fadeInError 0.5s;
}
@keyframes fadeInError {
    0% { opacity: 0; transform: translateY(-10px); }
    100% { opacity: 1; transform: none; }
}
.premium-form-help {
    font-size: 0.97rem;
    color: var(--aurora2);
    margin-top: 0.2rem;
    margin-left: 0.2rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
}
.premium-form-btn {
    background: linear-gradient(135deg, var(--aurora1) 0%, var(--aurora2) 100%);
    color: #fff;
    font-weight: 700;
    border-radius: 1.2rem;
    padding: 0.85rem 2.2rem;
    font-size: 1.15rem;
    box-shadow: 0 10px 15px -3px var(--primary-blue), 0 0 0 1px var(--aurora1);
    transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
    border: 2px solid var(--gold-premium);
    letter-spacing: 0.04em;
    display: flex;
    align-items: center;
    gap: 0.7rem;
}
.premium-form-btn:hover {
    background: linear-gradient(135deg, var(--btn-login) 0%, var(--btn-login-hover) 100%);
    transform: translateY(-2px) scale(1.03);
    box-shadow: 0 16px 32px -8px var(--aurora1), 0 0 0 3px var(--gold-premium);
}
.premium-form-cancel {
    border: 2px solid var(--gold-premium);
    color: var(--aurora1);
    background: var(--gold-bg);
    border-radius: 1.2rem;
    padding: 0.85rem 2.2rem;
    font-size: 1.15rem;
    font-weight: 700;
    margin-left: 1rem;
    transition: background 0.2s, color 0.2s;
    display: flex;
    align-items: center;
    gap: 0.7rem;
}
.premium-form-cancel:hover {
    background: var(--gold-hover);
    color: var(--aurora2);
}
.premium-table-servicios {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1.5rem;
}
.premium-table-servicios th, .premium-table-servicios td {
    padding: 0.6rem 0.5rem;
    font-size: 1.08rem;
    min-width: 90px;
    max-width: 220px;
    white-space: nowrap;
    text-align: center;
}
.premium-table-servicios th {
    background: linear-gradient(90deg, var(--aurora1), var(--aurora2) 80%, var(--gold-light) 100%);
    color: var(--gold-premium);
    font-weight: 700;
    border-bottom: 2px solid var(--gold-premium);
    font-size: 1.13rem;
}
.premium-table-servicios td input,
.premium-table-servicios td select {
    width: 100%;
    min-width: 60px;
    max-width: 120px;
    font-size: 1.05rem;
    padding: 0.3rem 0.7rem;
    border-radius: 0.7rem;
    border: 1.5px solid var(--gold-premium);
    background: #fffbe7;
}
.premium-table-servicios td input[type="checkbox"] {
    width: 1.2rem;
    height: 1.2rem;
}
@media (max-width: 900px) {
    .premium-table-servicios th, .premium-table-servicios td {
        font-size: 0.95rem;
        min-width: 60px;
        max-width: 120px;
        padding: 0.3rem 0.2rem;
    }
}
@media (max-width: 640px) {
    .premium-form-card {
        padding: 1.25rem 0.5rem;
        border-radius: 1.2rem;
    }
    .premium-form-title {
        font-size: 1.5rem;
        gap: 0.5rem;
    }
    .premium-form-title i {
        font-size: 1.5rem;
    }
}
</style>
<div class="premium-form-card mx-auto">
    <h2 class="premium-form-title">
        <span style="display:inline-block; background:linear-gradient(90deg, var(--aurora1), var(--aurora2) 80%, var(--gold-light) 100%); border-radius:1.2rem; padding:0.3rem 0.7rem; box-shadow:0 2px 12px var(--aurora1); margin-right:0.4rem;">
            <i class="fas fa-money-bill-wave" style="color:var(--gold-premium); filter:drop-shadow(0 2px 6px var(--gold-light));"></i>
        </span>
        <span class="premium-title-text">{{ form.instance.pk|yesno:'Editar Pago,Nuevo Pago' }}</span>
    </h2>
    {# Selección de Atención (opcional) y datos generales del pago #}
    <form method="post" novalidate autocomplete="off" enctype="multipart/form-data" id="form-pago-premium">
        {% csrf_token %}
        <div class="premium-form-group">
            <label for="id_atencion" class="premium-form-label">Atención (opcional)</label>
            <div class="premium-input-wrapper">
                <i class="fas fa-stethoscope premium-input-icon"></i>
                {{ form.atencion }}
            </div>
        </div>
        {# Datos del Pago: método, estado, evidencia, observaciones, etc. #}
        {% for field in form %}
            {% if field.name not in 'atencionfecha_pago' %}
            <div class="premium-form-group">
                <label for="{{ field.id_for_label }}" class="premium-form-label">{{ field.label }}</label>
                <div class="premium-input-wrapper">
                    <i class="fas fa-pen premium-input-icon" title="Campo"></i>
                    {{ field }}
                </div>
                {% if field.errors %}
                    <div class="premium-form-error">{{ field.errors|striptags }}</div>
                {% endif %}
                {% if field.help_text %}
                    <div class="premium-form-help"><i class="fas fa-circle-info"></i> {{ field.help_text }}</div>
                {% endif %}
            </div>
            {% endif %}
            {% if field.name == 'estado' %}
            <div class="premium-form-group" id="fecha-pago-group" style="display:none;">
                <label class="premium-form-label">Fecha de Pago</label>
                <div class="premium-input-wrapper">
                    <i class="fas fa-calendar premium-input-icon"></i>
                    <input type="text" class="form-control" id="fecha-pago-input" name="fecha_pago" value="{{ form.instance.fecha_pago|date:'d/m/Y H:i' }}" readonly>
                </div>
            </div>
            {% endif %}
        {% endfor %}
        <input type="hidden" name="detalles_data" id="detalles_data">
        <div class="flex justify-center mt-6 gap-4">
            <button type="submit" class="premium-form-btn">
                <i class="fas fa-floppy-disk"></i>
                Guardar
            </button>
            <button type="button" id="btn-paypal-pago" class="premium-form-btn" style="background:#fff; border:2px solid #0070ba; color:#0070ba; display:flex; align-items:center; gap:0.7rem;">
                <img src="{% static 'img/iconos/paypal.svg' %}" alt="PayPal" style="height:1.6rem; margin-right:0.5rem;">Pagar con PayPal
            </button>
            <a href="{% url 'doctor:pago_list' %}" class="premium-form-cancel">
                <i class="fas fa-xmark"></i>
                Cancelar
            </a>
        </div>
    </form>
</div>

{# Tabla dinámica de servicios detallados fuera del form para mayor expansión #}
<div class="premium-form-card mx-auto" style="max-width:90vw; margin-top:2.5rem;">
    <h3 class="premium-form-title" style="font-size:2rem;">
        <span style="display:inline-block; background:linear-gradient(90deg, var(--aurora2), var(--aurora1) 80%, var(--gold-light) 100%); border-radius:1.2rem; padding:0.2rem 0.6rem; box-shadow:0 2px 12px var(--aurora2); margin-right:0.4rem;">
            <i class="fas fa-list-alt" style="color:var(--gold-premium); filter:drop-shadow(0 2px 6px var(--gold-light));"></i>
        </span>
        <span class="premium-title-text">Servicios Detallados</span>
    </h3>
    <div class="overflow-x-auto">
        <table class="w-full text-center premium-table-servicios premium-card mb-4" id="tabla-servicios-detalle">
            <thead>
                <tr>
                    <th>Servicio</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Descuento (%)</th>
                    <th>Aplica Seguro</th>
                    <th>Valor Seguro</th>
                    <th>Descripción Seguro</th>
                    <th>Subtotal</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="detalle-servicios-body">
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="7" class="text-right font-bold">Total:</td>
                    <td id="total-pago" class="font-bold text-lg">$0.00</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>
    <button type="button" class="premium-form-btn" id="btn-agregar-servicio">
        <i class="fas fa-plus"></i> Agregar Servicio
    </button>
</div>
{# Modal AJAX para crear servicio adicional #}
<div id="modal-servicio-container" style="display:none;"></div>

{# --- JSON seguro para servicios --- #}
<script id="servicios-json" type="application/json">{{ servicios|safe }}</script>
{# --- JSON seguro para detalles (solo en edición) --- #}
{% if detalles and detalles|length > 0 %}
<script id="detalles-json" type="application/json">{{ detalles|safe }}</script>
{% endif %}

<script>
const serviciosDisponibles = JSON.parse(document.getElementById('servicios-json').textContent);
let detalles = [];
// Inicializar detalles desde backend si existen (edición)
const detallesJson = document.getElementById('detalles-json');
if (detallesJson) {
    detalles = JSON.parse(detallesJson.textContent).map(d => ({
        servicio_adicional: d.servicio_adicional_id,
        cantidad: d.cantidad,
        precio_unitario: parseFloat(d.precio_unitario),
        descuento_porcentaje: parseFloat(d.descuento_porcentaje),
        aplica_seguro: d.aplica_seguro,
        valor_seguro: parseFloat(d.valor_seguro),
        descripcion_seguro: d.descripcion_seguro || ''
    }));
}

function renderTablaServicios() {
    const tbody = document.getElementById('detalle-servicios-body');
    tbody.innerHTML = '';
    let total = 0;
    detalles.forEach((d, idx) => {
        const subtotal = ((d.cantidad * d.precio_unitario) * (1 - (d.descuento_porcentaje||0)/100)) - (d.aplica_seguro ? (d.valor_seguro||0) : 0);
        total += subtotal > 0 ? subtotal : 0;
        tbody.innerHTML += `
        <tr>
            <td>
                <select class="form-control" onchange="actualizarServicio(${idx}, this.value)">
                    ${serviciosDisponibles.map(s => `<option value="${s.id}" ${d.servicio_adicional==s.id?'selected':''}>${s.nombre_servicio}</option>`).join('')}
                </select>
            </td>
            <td><input type="number" min="1" class="form-control" value="${d.cantidad}" onchange="actualizarCampo(${idx}, 'cantidad', this.value)"></td>
            <td><input type="number" min="0" step="0.01" class="form-control" value="${d.precio_unitario}" onchange="actualizarCampo(${idx}, 'precio_unitario', this.value)"></td>
            <td><input type="number" min="0" max="100" step="0.01" class="form-control" value="${d.descuento_porcentaje||''}" onchange="actualizarCampo(${idx}, 'descuento_porcentaje', this.value)"></td>
            <td><input type="checkbox" ${d.aplica_seguro?'checked':''} onchange="actualizarCampo(${idx}, 'aplica_seguro', this.checked)"></td>
            <td><input type="number" min="0" step="0.01" class="form-control" value="${d.valor_seguro||''}" onchange="actualizarCampo(${idx}, 'valor_seguro', this.value)" ${d.aplica_seguro?'':'disabled'}></td>
            <td><input type="text" class="form-control" value="${d.descripcion_seguro||''}" onchange="actualizarCampo(${idx}, 'descripcion_seguro', this.value)" ${d.aplica_seguro?'':'disabled'}></td>
            <td>$${subtotal.toFixed(2)}</td>
            <td><button type="button" class="premium-form-cancel" onclick="eliminarDetalle(${idx})"><i class="fas fa-trash"></i></button></td>
        </tr>`;
    });
    document.getElementById('total-pago').textContent = `$${total.toFixed(2)}`;
    document.getElementById('detalles_data').value = JSON.stringify(detalles);
}
function actualizarCampo(idx, campo, valor) {
    if(campo==='aplica_seguro') valor = !!valor;
    if(campo==='cantidad' || campo==='precio_unitario' || campo==='descuento_porcentaje' || campo==='valor_seguro') valor = parseFloat(valor)||0;
    detalles[idx][campo] = valor;
    if(campo==='aplica_seguro' && !valor) {
        detalles[idx]['valor_seguro'] = 0;
        detalles[idx]['descripcion_seguro'] = '';
    }
    renderTablaServicios();
}
function actualizarServicio(idx, id) {
    detalles[idx]['servicio_adicional'] = parseInt(id);
    // Actualizar precio_unitario automáticamente
    const s = serviciosDisponibles.find(x=>x.id==id);
    if(s) detalles[idx]['precio_unitario'] = parseFloat(s.costo_servicio);
    renderTablaServicios();
}
function eliminarDetalle(idx) {
    detalles.splice(idx,1);
    renderTablaServicios();
}
document.getElementById('btn-agregar-servicio').onclick = function() {
    detalles.push({
        servicio_adicional: serviciosDisponibles.length ? serviciosDisponibles[0].id : null,
        cantidad: 1,
        precio_unitario: serviciosDisponibles.length ? parseFloat(serviciosDisponibles[0].costo_servicio) : 0,
        descuento_porcentaje: 0,
        aplica_seguro: false,
        valor_seguro: 0,
        descripcion_seguro: ''
    });
    renderTablaServicios();
};
renderTablaServicios();

// --- Modal AJAX para crear servicio adicional premium ---
const modalServicioContainer = document.getElementById('modal-servicio-container');
window.abrirModalServicio = function() {
    fetch("{% url 'doctor:servicio_create_ajax' %}", {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(function(data) {
        modalServicioContainer.innerHTML = data.html;
        modalServicioContainer.style.display = 'block';
        document.body.classList.add('modal-open');
        window.cerrarModalServicioFn = function() {
            modalServicioContainer.innerHTML = '';
            modalServicioContainer.style.display = 'none';
            document.body.classList.remove('modal-open');
        };
        window.onServicioCreado = function(servicio) {
            serviciosDisponibles.push({id: servicio.id, nombre: servicio.nombre, precio: servicio.costo});
            detalles.forEach(d => {
                // Si el usuario quiere, puede seleccionar el nuevo servicio en la fila actual
            });
            renderTablaServicios();
        };
    });
};
// Antes de enviar el form, asegura que detalles_data esté actualizado
const formPago = document.getElementById('form-pago-premium');
formPago.addEventListener('submit', function(e) {
    document.getElementById('detalles_data').value = JSON.stringify(detalles);
});
</script>
<script>
// Mostrar/ocultar fecha de pago según estado
function toggleFechaPago() {
    const estadoField = document.getElementById('id_estado');
    const fechaPagoGroup = document.getElementById('fecha-pago-group');
    const fechaPagoInput = document.getElementById('fecha-pago-input');
    if (estadoField && fechaPagoGroup && fechaPagoInput) {
        if (estadoField.value === 'pagado') {
            fechaPagoGroup.style.display = '';
            // Solo setear si está vacío
            if (!fechaPagoInput.value) {
                const now = new Date();
                const pad = n => n.toString().padStart(2, '0');
                fechaPagoInput.value = `${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
            }
        } else {
            fechaPagoGroup.style.display = 'none';
            fechaPagoInput.value = '';
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const estadoField = document.getElementById('id_estado');
    if (estadoField) {
        estadoField.addEventListener('change', toggleFechaPago);
        toggleFechaPago(); // inicial
    }
});
</script>
<!-- SDK de PayPal (sandbox) -->
<script src="https://www.sandbox.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}&currency=USD"></script>
<script>
// --- Habilitar/deshabilitar botón PayPal según método seleccionado ---
function togglePaypalBtn() {
    const metodo = document.getElementById('id_metodo_pago');
    const btnPaypal = document.getElementById('btn-paypal-pago');
    if (metodo && btnPaypal) {
        if (metodo.value && metodo.value.toLowerCase() === 'paypal') {
            btnPaypal.style.display = 'flex';
        } else {
            btnPaypal.style.display = 'none';
        }
    }
}
document.addEventListener('DOMContentLoaded', function() {
    const metodo = document.getElementById('id_metodo_pago');
    if (metodo) {
        metodo.addEventListener('change', togglePaypalBtn);
        togglePaypalBtn();
    }
});

// --- Botón PayPal ---
document.getElementById('btn-paypal-pago').onclick = async function() {
    const metodo = document.getElementById('id_metodo_pago');
    if (!metodo || metodo.value.toLowerCase() !== 'paypal') {
        alert('Selecciona PayPal como método de pago para continuar.');
        return;
    }
    // Calcula el total actual de la tabla
    let total = 0;
    detalles.forEach((d) => {
        const subtotal = ((d.cantidad * d.precio_unitario) * (1 - (d.descuento_porcentaje||0)/100)) - (d.aplica_seguro ? (d.valor_seguro||0) : 0);
        total += subtotal > 0 ? subtotal : 0;
    });
    if (total <= 0) {
        alert('Debes agregar al menos un servicio válido para pagar con PayPal.');
        return;
    }
    // Crea la orden PayPal vía AJAX
    const formData = new FormData();
    formData.append('monto', total.toFixed(2));
    const resp = await fetch("{% url 'doctor:pago_paypal_create_order' %}", {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': '{{ csrf_token }}' },
        body: formData
    });
    const data = await resp.json();
    if (data.orderID) {
        // Redirige a PayPal sandbox para pruebas
        window.location.href = `https://www.sandbox.paypal.com/checkoutnow?token=${data.orderID}`;
    } else {
        alert('Error creando la orden PayPal: ' + (data.error || 'Desconocido'));
    }
};
</script>
{% endblock %}
